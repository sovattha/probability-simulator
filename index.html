<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ² Simulateur de ProbabilitÃ©s</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      padding: 2rem;
      background: rgba(0,0,0,0.3);
      position: relative;
    }
    .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .header p { color: #888; }

    .lang-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.25rem;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 0.25rem;
    }
    .lang-btn {
      padding: 0.5rem 0.75rem;
      border: none;
      background: transparent;
      color: #888;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .lang-btn:hover { color: #eee; }
    .lang-btn.active {
      background: #e94560;
      color: white;
    }

    .main-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      min-height: calc(100vh - 120px);
    }

    /* Sidebar */
    .sidebar {
      background: rgba(0,0,0,0.4);
      padding: 1.5rem;
      border-right: 1px solid rgba(255,255,255,0.1);
      overflow-y: auto;
    }
    .sidebar h3 { color: #e94560; margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }

    .mode-selector {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    .mode-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: #eee;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .mode-btn:hover { background: rgba(255,255,255,0.1); }
    .mode-btn.active {
      background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
      border-color: #e94560;
    }
    .mode-btn .mode-icon { font-size: 1.2rem; margin-right: 0.5rem; }
    .mode-btn .mode-name { font-weight: 600; }
    .mode-btn .mode-desc { font-size: 0.75rem; color: #aaa; display: block; margin-top: 0.25rem; }
    .mode-btn.active .mode-desc { color: #ddd; }

    .config-section { margin-bottom: 1.5rem; }
    .config-section label {
      display: block;
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 0.25rem;
    }
    .config-section input, .config-section select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: #eee;
      font-size: 1rem;
    }
    .config-section input:focus, .config-section select:focus {
      outline: none;
      border-color: #e94560;
    }

    .config-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .run-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #e94560 0%, #c73659 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .run-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(233,69,96,0.4); }
    .run-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Content */
    .content {
      padding: 2rem;
      overflow-y: auto;
    }

    .placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      text-align: center;
    }
    .placeholder .icon { font-size: 4rem; margin-bottom: 1rem; }

    .results { display: none; }
    .results.visible { display: block; }

    .info-box {
      background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid #0f3460;
    }
    .info-box h2 { color: #e94560; margin-bottom: 1rem; font-size: 1.25rem; }
    .info-box p { line-height: 1.7; margin-bottom: 0.5rem; font-size: 0.95rem; }
    .info-box .highlight { color: #e94560; font-weight: bold; }

    .child-box {
      background: linear-gradient(135deg, #4a1942 0%, #16213e 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid #4a1942;
    }
    .child-box h2 { color: #f0a6ca; margin-bottom: 1rem; font-size: 1.25rem; }
    .child-box p { line-height: 1.8; margin-bottom: 0.5rem; font-size: 1rem; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-card .value { font-size: 1.5rem; font-weight: bold; color: #e94560; }
    .stat-card .label { color: #888; font-size: 0.75rem; margin-top: 0.25rem; }
    .stat-card.lucky .value { color: #4ade80; }
    .stat-card.unlucky .value { color: #f97316; }

    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 1100px) {
      .charts-row { grid-template-columns: 1fr; }
    }

    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .chart-container h3 { margin-bottom: 0.5rem; color: #e94560; font-size: 1rem; }
    .chart-container canvas { max-height: 200px; }
    .chart-explanation {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.85rem;
      color: #aaa;
      line-height: 1.5;
    }

    .moral-box {
      background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
    }
    .moral-box h2 { margin-bottom: 0.75rem; font-size: 1.25rem; }
    .moral-box .quote { font-size: 1.1rem; font-style: italic; opacity: 0.95; line-height: 1.6; }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin-top: 1rem;
      overflow: hidden;
      display: none;
    }
    .progress-bar.visible { display: block; }
    .progress-bar .fill {
      height: 100%;
      background: #e94560;
      width: 0%;
      transition: width 0.3s;
    }

    @media (max-width: 900px) {
      .main-container { grid-template-columns: 1fr; }
      .sidebar { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="lang-toggle">
      <button class="lang-btn active" data-lang="fr">FR</button>
      <button class="lang-btn" data-lang="en">EN</button>
    </div>
    <h1 id="mainTitle">ğŸ² Simulateur de ProbabilitÃ©s</h1>
    <p id="mainSubtitle">Explore diffÃ©rents scÃ©narios et dÃ©couvre ce que les statistiques nous apprennent</p>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <h3 id="modeTitle">ğŸ® Mode de jeu</h3>
      <div class="mode-selector">
        <button class="mode-btn active" data-mode="replacement">
          <span class="mode-icon">ğŸ”„</span>
          <span class="mode-name" data-i18n="mode.replacement.name">Avec remise</span>
          <span class="mode-desc" data-i18n="mode.replacement.desc">La boule retourne dans le sac</span>
        </button>
        <button class="mode-btn" data-mode="no-replacement">
          <span class="mode-icon">ğŸ¯</span>
          <span class="mode-name" data-i18n="mode.noReplacement.name">Sans remise</span>
          <span class="mode-desc" data-i18n="mode.noReplacement.desc">La boule est gardÃ©e</span>
        </button>
        <button class="mode-btn" data-mode="pity">
          <span class="mode-icon">ğŸ°</span>
          <span class="mode-name" data-i18n="mode.pity.name">Pity System</span>
          <span class="mode-desc" data-i18n="mode.pity.desc">Garantie aprÃ¨s X Ã©checs</span>
        </button>
        <button class="mode-btn" data-mode="competition">
          <span class="mode-icon">ğŸ†</span>
          <span class="mode-name" data-i18n="mode.competition.name">CompÃ©tition</span>
          <span class="mode-desc" data-i18n="mode.competition.desc">Course au premier</span>
        </button>
        <button class="mode-btn" data-mode="streak">
          <span class="mode-icon">ğŸ”¥</span>
          <span class="mode-name" data-i18n="mode.streak.name">Streaks</span>
          <span class="mode-desc" data-i18n="mode.streak.desc">Main chaude / froide</span>
        </button>
        <button class="mode-btn" data-mode="economy">
          <span class="mode-icon">ğŸ’°</span>
          <span class="mode-name" data-i18n="mode.economy.name">Ã‰conomie</span>
          <span class="mode-desc" data-i18n="mode.economy.desc">CoÃ»t vs RÃ©compense</span>
        </button>
        <button class="mode-btn" data-mode="multi">
          <span class="mode-icon">ğŸ¯</span>
          <span class="mode-name" data-i18n="mode.multi.name">Multi-cibles</span>
          <span class="mode-desc" data-i18n="mode.multi.desc">Trouver N boules bleues</span>
        </button>
      </div>

      <h3 id="configTitle">âš™ï¸ Configuration</h3>

      <div class="config-section">
        <label data-i18n="config.players">Nombre de joueurs</label>
        <input type="number" id="players" value="100000" min="1000" max="1000000" step="1000">
      </div>

      <div class="config-group">
        <div class="config-section">
          <label data-i18n="config.redBalls">Boules rouges</label>
          <input type="number" id="redBalls" value="499" min="1" max="9999">
        </div>
        <div class="config-section">
          <label data-i18n="config.blueBalls">Boules bleues</label>
          <input type="number" id="blueBalls" value="1" min="1" max="100">
        </div>
      </div>

      <!-- Mode-specific configs -->
      <div id="pity-config" class="config-section" style="display:none;">
        <label data-i18n="config.pityStart">Pity dÃ©marre aprÃ¨s</label>
        <input type="number" id="pityStart" value="50" min="1">
        <label style="margin-top:0.5rem;" data-i18n="config.pityGuarantee">Garantie Ã </label>
        <input type="number" id="pityGuarantee" value="90" min="1">
      </div>

      <div id="competition-config" class="config-section" style="display:none;">
        <label data-i18n="config.playersPerGame">Joueurs par partie</label>
        <input type="number" id="playersPerGame" value="10" min="2" max="100">
      </div>

      <div id="streak-config" class="config-section" style="display:none;">
        <label data-i18n="config.streakBonus">Bonus/Malus par streak (%)</label>
        <input type="number" id="streakBonus" value="10" min="-50" max="50">
      </div>

      <div id="economy-config" class="config-section" style="display:none;">
        <div class="config-group">
          <div>
            <label data-i18n="config.cost">CoÃ»t par essai</label>
            <input type="number" id="cost" value="1" min="1">
          </div>
          <div>
            <label data-i18n="config.reward">RÃ©compense</label>
            <input type="number" id="reward" value="400" min="1">
          </div>
        </div>
      </div>

      <div id="multi-config" class="config-section" style="display:none;">
        <label data-i18n="config.targetBalls">Boules bleues Ã  trouver</label>
        <input type="number" id="targetBalls" value="3" min="1" max="10">
      </div>

      <button class="run-btn" id="runBtn" data-i18n="ui.runBtn">â–¶ï¸ Lancer la simulation</button>
      <div class="progress-bar" id="progressBar"><div class="fill"></div></div>
    </div>

    <div class="content">
      <div class="placeholder" id="placeholder">
        <div class="icon">ğŸ²</div>
        <h2 data-i18n="ui.placeholder.title">Choisis un mode et lance la simulation</h2>
        <p style="margin-top:0.5rem;" data-i18n="ui.placeholder.subtitle">Les rÃ©sultats apparaÃ®tront ici</p>
      </div>

      <div class="results" id="results">
        <div class="info-box" id="storyBox"></div>
        <div class="stats-grid" id="statsGrid"></div>

        <div class="charts-row">
          <div class="chart-container">
            <h3 data-i18n="ui.chart.distribution">ğŸ“Š Distribution</h3>
            <canvas id="distributionChart"></canvas>
            <div class="chart-explanation" id="distExplanation"></div>
          </div>
          <div class="chart-container">
            <h3 data-i18n="ui.chart.cumulative">ğŸ“ˆ Cumul</h3>
            <canvas id="cumulativeChart"></canvas>
            <div class="chart-explanation" id="cumulExplanation"></div>
          </div>
        </div>

        <div class="child-box" id="childBox"></div>
        <div class="moral-box" id="moralBox"></div>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentMode = 'replacement';
    let currentLang = 'fr';
    let distributionChart = null;
    let cumulativeChart = null;

    // Translations
    const translations = {
      fr: {
        title: 'ğŸ² Simulateur de ProbabilitÃ©s',
        subtitle: 'Explore diffÃ©rents scÃ©narios et dÃ©couvre ce que les statistiques nous apprennent',
        modeTitle: 'ğŸ® Mode de jeu',
        configTitle: 'âš™ï¸ Configuration',
        mode: {
          replacement: { name: 'Avec remise', desc: 'La boule retourne dans le sac' },
          noReplacement: { name: 'Sans remise', desc: 'La boule est gardÃ©e' },
          pity: { name: 'Pity System', desc: 'Garantie aprÃ¨s X Ã©checs' },
          competition: { name: 'CompÃ©tition', desc: 'Course au premier' },
          streak: { name: 'Streaks', desc: 'Main chaude / froide' },
          economy: { name: 'Ã‰conomie', desc: 'CoÃ»t vs RÃ©compense' },
          multi: { name: 'Multi-cibles', desc: 'Trouver N boules bleues' }
        },
        config: {
          players: 'Nombre de joueurs',
          redBalls: 'Boules rouges',
          blueBalls: 'Boules bleues',
          pityStart: 'Pity dÃ©marre aprÃ¨s',
          pityGuarantee: 'Garantie Ã ',
          playersPerGame: 'Joueurs par partie',
          streakBonus: 'Bonus/Malus par streak (%)',
          cost: 'CoÃ»t par essai',
          reward: 'RÃ©compense',
          targetBalls: 'Boules bleues Ã  trouver'
        },
        ui: {
          runBtn: 'â–¶ï¸ Lancer la simulation',
          runningBtn: 'â³ Simulation...',
          placeholder: { title: 'Choisis un mode et lance la simulation', subtitle: 'Les rÃ©sultats apparaÃ®tront ici' },
          chart: { distribution: 'ğŸ“Š Distribution', cumulative: 'ğŸ“ˆ Cumul' },
          stats: { lucky: 'Chanceux', max: 'Max', average: 'Moyenne', median: 'MÃ©diane', p50: '50% en â‰¤', p90: '90% en â‰¤' }
        },
        balls: 'boules',
        ball: 'boule',
        attempts: 'tentatives',
        attempt: 'tentative',
        players: 'joueurs',
        player: 'joueur',
        games: 'parties'
      },
      en: {
        title: 'ğŸ² Probability Simulator',
        subtitle: 'Explore different scenarios and discover what statistics teach us',
        modeTitle: 'ğŸ® Game Mode',
        configTitle: 'âš™ï¸ Configuration',
        mode: {
          replacement: { name: 'With replacement', desc: 'Ball goes back in the bag' },
          noReplacement: { name: 'Without replacement', desc: 'Ball is kept' },
          pity: { name: 'Pity System', desc: 'Guaranteed after X failures' },
          competition: { name: 'Competition', desc: 'Race to first' },
          streak: { name: 'Streaks', desc: 'Hot / cold hand' },
          economy: { name: 'Economy', desc: 'Cost vs Reward' },
          multi: { name: 'Multi-target', desc: 'Find N blue balls' }
        },
        config: {
          players: 'Number of players',
          redBalls: 'Red balls',
          blueBalls: 'Blue balls',
          pityStart: 'Pity starts after',
          pityGuarantee: 'Guaranteed at',
          playersPerGame: 'Players per game',
          streakBonus: 'Bonus/Malus per streak (%)',
          cost: 'Cost per try',
          reward: 'Reward',
          targetBalls: 'Blue balls to find'
        },
        ui: {
          runBtn: 'â–¶ï¸ Run simulation',
          runningBtn: 'â³ Simulating...',
          placeholder: { title: 'Choose a mode and run the simulation', subtitle: 'Results will appear here' },
          chart: { distribution: 'ğŸ“Š Distribution', cumulative: 'ğŸ“ˆ Cumulative' },
          stats: { lucky: 'Lucky', max: 'Max', average: 'Average', median: 'Median', p50: '50% in â‰¤', p90: '90% in â‰¤' }
        },
        balls: 'balls',
        ball: 'ball',
        attempts: 'attempts',
        attempt: 'attempt',
        players: 'players',
        player: 'player',
        games: 'games'
      }
    };

    function t(key) {
      const keys = key.split('.');
      let value = translations[currentLang];
      for (const k of keys) {
        value = value?.[k];
      }
      return value || key;
    }

    function updateStaticUI() {
      document.getElementById('mainTitle').textContent = t('title');
      document.getElementById('mainSubtitle').textContent = t('subtitle');
      document.getElementById('modeTitle').textContent = t('modeTitle');
      document.getElementById('configTitle').textContent = t('configTitle');
      document.getElementById('runBtn').textContent = t('ui.runBtn');

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        const text = t(key);
        if (text && text !== key) el.textContent = text;
      });
    }

    // Mode configurations
    const modeConfigs = {
      replacement: { showConfigs: [] },
      'no-replacement': { showConfigs: [] },
      pity: { showConfigs: ['pity-config'] },
      competition: { showConfigs: ['competition-config'] },
      streak: { showConfigs: ['streak-config'] },
      economy: { showConfigs: ['economy-config'] },
      multi: { showConfigs: ['multi-config'] }
    };

    // Mode stories and morals - bilingual
    function getModeContent(mode) {
      const content = {
        replacement: {
          fr: {
            storyTitle: "ğŸ“– L'Histoire",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              return `<p>Imagine un sac contenant <span class="highlight">${c.totalBalls} boules</span>: ${c.redBalls} ğŸ”´ rouges et ${c.blueBalls} ğŸ”µ bleue(s).</p>
              <p><span class="highlight">${c.players.toLocaleString()}</span> joueurs vont tenter leur chance.</p>
              <p>Chacun pioche une boule au hasard, <strong>la remet dans le sac</strong>, et recommence jusqu'Ã  trouver la bleue.</p>
              <p>ğŸ€ <strong>${lucky.toLocaleString()}</strong> chanceux ont trouvÃ© du premier coup! ğŸ˜… Le plus malchanceux: <strong>${s.max.toLocaleString()}</strong> tentatives.</p>`;
            },
            distExp: (c, s) => `<strong>Ce graphique montre combien de joueurs ont eu besoin de X tentatives.</strong> La barre la plus haute est Ã  gauche (1 tentative) et dÃ©croÃ®t exponentiellement. C'est la "distribution gÃ©omÃ©trique" - typique des jeux de hasard avec remise.`,
            cumulExp: (c, s, p50, p90) => `<strong>Ce graphique montre le % de joueurs ayant rÃ©ussi en X tentatives ou moins.</strong> Ã€ ${p50} tentatives, 50% ont rÃ©ussi. Ã€ ${p90}, c'est 90%. La courbe monte vite au dÃ©but puis ralentit - les derniers % sont les plus durs!`,
            childTitle: "ğŸ§’ ExpliquÃ© Ã  un enfant de 8 ans",
            child: (c, s) => `<p>Imagine que tu cherches une bille bleue dans un sac de ${c.totalBalls} billes. Tu pioches, tu regardes, et tu remets la bille dans le sac. Puis tu recommences!</p><p>Certains ont beaucoup de chance et trouvent tout de suite. D'autres doivent essayer plein de fois - jusqu'Ã  ${s.max.toLocaleString()} fois pour le moins chanceux!</p><p><strong>Mais tu sais quoi? Ã€ la fin, TOUT LE MONDE trouve la bille bleue.</strong> Il faut juste Ãªtre patient! ğŸ‰</p>`,
            moralTitle: "ğŸ’¡ Ce que Ã§a nous apprend",
            moral: () => `<p class="quote">ğŸ¯ La chance dÃ©termine le "quand", pas le "si".<br><strong>Celui qui persÃ©vÃ¨re gagne toujours.</strong></p>`
          },
          en: {
            storyTitle: "ğŸ“– The Story",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              return `<p>Imagine a bag containing <span class="highlight">${c.totalBalls} balls</span>: ${c.redBalls} ğŸ”´ red and ${c.blueBalls} ğŸ”µ blue.</p>
              <p><span class="highlight">${c.players.toLocaleString()}</span> players will try their luck.</p>
              <p>Each one picks a ball at random, <strong>puts it back in the bag</strong>, and tries again until they find the blue one.</p>
              <p>ğŸ€ <strong>${lucky.toLocaleString()}</strong> lucky ones found it on the first try! ğŸ˜… The unluckiest: <strong>${s.max.toLocaleString()}</strong> attempts.</p>`;
            },
            distExp: (c, s) => `<strong>This chart shows how many players needed X attempts.</strong> The highest bar is on the left (1 attempt) and decreases exponentially. This is the "geometric distribution" - typical of games of chance with replacement.`,
            cumulExp: (c, s, p50, p90) => `<strong>This chart shows the % of players who succeeded in X attempts or less.</strong> At ${p50} attempts, 50% succeeded. At ${p90}, it's 90%. The curve rises quickly at first then slows - the last % are the hardest!`,
            childTitle: "ğŸ§’ Explained to an 8-year-old",
            child: (c, s) => `<p>Imagine you're looking for a blue marble in a bag of ${c.totalBalls} marbles. You pick one, look at it, and put it back in the bag. Then you try again!</p><p>Some people are very lucky and find it right away. Others have to try many times - up to ${s.max.toLocaleString()} times for the unluckiest!</p><p><strong>But guess what? In the end, EVERYONE finds the blue marble.</strong> You just need to be patient! ğŸ‰</p>`,
            moralTitle: "ğŸ’¡ What this teaches us",
            moral: () => `<p class="quote">ğŸ¯ Luck determines "when", not "if".<br><strong>Those who persevere always win.</strong></p>`
          }
        },
        'no-replacement': {
          fr: {
            storyTitle: "ğŸ“– L'Histoire",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              return `<p>MÃªme sac de <span class="highlight">${c.totalBalls} boules</span>, mais cette fois on <strong>garde</strong> chaque boule piochÃ©e!</p>
              <p>La probabilitÃ© augmente Ã  chaque tirage. Maximum ${c.totalBalls} tentatives possible.</p>
              <p>ğŸ€ <strong>${lucky.toLocaleString()}</strong> chanceux au 1er coup! ğŸ˜… Le plus malchanceux: <strong>${s.max}</strong>/${c.totalBalls} tentatives.</p>`;
            },
            distExp: () => `<strong>Distribution plus "plate" qu'avec remise.</strong> Chaque nombre de tentatives a presque la mÃªme probabilitÃ©! C'est la "distribution uniforme" - chaque position dans le sac est Ã©quiprobable.`,
            cumulExp: (c, s, p50) => `<strong>Ligne presque droite = progression rÃ©guliÃ¨re.</strong> Ã€ ${p50} tentatives, 50% ont rÃ©ussi. La mÃ©diane est proche de ${c.totalBalls}/2. Contrairement au mode "avec remise", pas de longue traÃ®ne!`,
            childTitle: "ğŸ§’ ExpliquÃ© Ã  un enfant de 8 ans",
            child: (c, s) => `<p>Cette fois, quand tu pioches une bille rouge, tu la gardes au lieu de la remettre!</p><p>C'est comme si le sac devenait de plus en plus petit. Au bout d'un moment, il ne reste que la bille bleue!</p><p><strong>Le plus malchanceux a dÃ» vider presque tout le sac (${s.max} billes), mais au moins il y a une limite!</strong> C'est plus "juste" ğŸ¤—</p>`,
            moralTitle: "ğŸ’¡ Ce que Ã§a nous apprend",
            moral: (c) => `<p class="quote">âœ… Sans remise, victoire GARANTIE en ${c.totalBalls} essais max.<br><strong>Le systÃ¨me protÃ¨ge contre la malchance extrÃªme.</strong></p>`
          },
          en: {
            storyTitle: "ğŸ“– The Story",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              return `<p>Same bag of <span class="highlight">${c.totalBalls} balls</span>, but this time you <strong>keep</strong> each ball you pick!</p>
              <p>The probability increases with each draw. Maximum ${c.totalBalls} attempts possible.</p>
              <p>ğŸ€ <strong>${lucky.toLocaleString()}</strong> lucky on 1st try! ğŸ˜… Unluckiest: <strong>${s.max}</strong>/${c.totalBalls} attempts.</p>`;
            },
            distExp: () => `<strong>"Flatter" distribution than with replacement.</strong> Each number of attempts has almost the same probability! This is the "uniform distribution" - each position in the bag is equally likely.`,
            cumulExp: (c, s, p50) => `<strong>Almost straight line = regular progression.</strong> At ${p50} attempts, 50% succeeded. The median is close to ${c.totalBalls}/2. Unlike "with replacement" mode, no long tail!`,
            childTitle: "ğŸ§’ Explained to an 8-year-old",
            child: (c, s) => `<p>This time, when you pick a red marble, you keep it instead of putting it back!</p><p>It's like the bag gets smaller and smaller. Eventually, only the blue marble is left!</p><p><strong>The unluckiest had to empty almost the entire bag (${s.max} marbles), but at least there's a limit!</strong> It's more "fair" ğŸ¤—</p>`,
            moralTitle: "ğŸ’¡ What this teaches us",
            moral: (c) => `<p class="quote">âœ… Without replacement, victory is GUARANTEED in ${c.totalBalls} tries max.<br><strong>The system protects against extreme bad luck.</strong></p>`
          }
        },
        pity: {
          fr: {
            storyTitle: "ğŸ“– L'Histoire - SystÃ¨me Pity (Gacha)",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              return `<p>ProbabilitÃ© de base: <span class="highlight">1/${c.totalBalls}</span>. AprÃ¨s <strong>${c.pityStart}</strong> Ã©checs, elle augmente!</p>
              <p>Ã€ <strong>${c.pityGuarantee}</strong> tentatives = <span class="highlight">100% GARANTI</span> ğŸ°</p>
              <p>ğŸ€ ${lucky.toLocaleString()} chanceux naturels | ğŸ˜… Max: ${s.max} (â‰¤${c.pityGuarantee})</p>`;
            },
            distExp: () => `<strong>Pic vers la fin = joueurs "sauvÃ©s" par le pity.</strong> Beaucoup arrivent prÃ¨s de la garantie avant de gagner. C'est calculÃ© pour maximiser les dÃ©penses tout en Ã©vitant la frustration totale.`,
            cumulExp: (c) => `<strong>La courbe accÃ©lÃ¨re vers la fin!</strong> Contrairement au mode normal, 100% est atteint Ã  exactement ${c.pityGuarantee} tentatives. Le pity "rattrape" tous les malchanceux.`,
            childTitle: "ğŸ§’ ExpliquÃ© Ã  un enfant de 8 ans",
            child: (c) => `<p>C'est comme dans les jeux sur tÃ©lÃ©phone! Au dÃ©but c'est dur de gagner...</p><p>Mais si tu n'as vraiment pas de chance, le jeu devient plus gentil et te laisse gagner aprÃ¨s ${c.pityGuarantee} essais!</p><p><strong>Attention:</strong> Les crÃ©ateurs du jeu ont calculÃ© Ã§a pour que tu aies ENVIE de continuer Ã  jouer (et payer) ğŸ’¸</p>`,
            moralTitle: "ğŸ’¡ Ce que Ã§a nous apprend",
            moral: () => `<p class="quote">ğŸ° Le Pity donne une <strong>illusion de protection</strong>.<br><strong>C'est un outil marketing, pas un cadeau.</strong></p>`
          },
          en: {
            storyTitle: "ğŸ“– The Story - Pity System (Gacha)",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              return `<p>Base probability: <span class="highlight">1/${c.totalBalls}</span>. After <strong>${c.pityStart}</strong> failures, it increases!</p>
              <p>At <strong>${c.pityGuarantee}</strong> attempts = <span class="highlight">100% GUARANTEED</span> ğŸ°</p>
              <p>ğŸ€ ${lucky.toLocaleString()} naturally lucky | ğŸ˜… Max: ${s.max} (â‰¤${c.pityGuarantee})</p>`;
            },
            distExp: () => `<strong>Spike near the end = players "saved" by pity.</strong> Many get close to the guarantee before winning. It's designed to maximize spending while avoiding total frustration.`,
            cumulExp: (c) => `<strong>The curve accelerates at the end!</strong> Unlike normal mode, 100% is reached at exactly ${c.pityGuarantee} attempts. Pity "catches" all the unlucky ones.`,
            childTitle: "ğŸ§’ Explained to an 8-year-old",
            child: (c) => `<p>It's like in mobile games! At first it's hard to win...</p><p>But if you're really unlucky, the game becomes nicer and lets you win after ${c.pityGuarantee} tries!</p><p><strong>Warning:</strong> Game creators designed this to make you WANT to keep playing (and paying) ğŸ’¸</p>`,
            moralTitle: "ğŸ’¡ What this teaches us",
            moral: () => `<p class="quote">ğŸ° Pity gives an <strong>illusion of protection</strong>.<br><strong>It's a marketing tool, not a gift.</strong></p>`
          }
        },
        competition: {
          fr: {
            storyTitle: "ğŸ“– L'Histoire - CompÃ©tition",
            story: (c, s, d) => {
              const w = c.winsByPosition || [];
              return `<p><strong>${c.playersPerGame}</strong> joueurs autour du mÃªme sac, Ã  tour de rÃ´le (sans remise).</p>
              <p>Premier Ã  trouver la ğŸ”µ = GAGNE! (${c.games?.toLocaleString() || 0} parties jouÃ©es)</p>
              <p>ğŸ¥‡ Joueur 1: <strong>${((w[0]||0)/(c.games||1)*100).toFixed(1)}%</strong> | ğŸ¥ˆ Joueur 2: <strong>${((w[1]||0)/(c.games||1)*100).toFixed(1)}%</strong> | ğŸ¥‰ Joueur 3: <strong>${((w[2]||0)/(c.games||1)*100).toFixed(1)}%</strong></p>`;
            },
            distExp: () => `<strong>Ce graphique montre quelle position gagne le plus souvent.</strong> Le joueur 1 a un avantage Ã©norme car il pioche en premier! Plus on est loin dans l'ordre, moins on a de chances.`,
            cumulExp: () => `<strong>Cumul des victoires par position.</strong> Les premiÃ¨res positions accumulent rapidement les victoires. Les derniers joueurs n'ont presque jamais leur chance!`,
            childTitle: "ğŸ§’ ExpliquÃ© Ã  un enfant de 8 ans",
            child: (c) => `<p>Imagine un jeu oÃ¹ ${c.playersPerGame} enfants piochent chacun leur tour dans le mÃªme sac.</p><p>Le premier qui trouve la bille bleue a gagnÃ©!</p><p><strong>C'est pas trÃ¨s juste:</strong> celui qui commence a beaucoup plus de chances! C'est pour Ã§a qu'on tire au sort qui commence ğŸ²</p>`,
            moralTitle: "ğŸ’¡ Ce que Ã§a nous apprend",
            moral: () => `<p class="quote">ğŸ† L'ordre de passage donne un <strong>avantage structurel</strong>.<br><strong>ÃŠtre premier compte souvent plus que le talent.</strong></p>`
          },
          en: {
            storyTitle: "ğŸ“– The Story - Competition",
            story: (c, s, d) => {
              const w = c.winsByPosition || [];
              return `<p><strong>${c.playersPerGame}</strong> players around the same bag, taking turns (no replacement).</p>
              <p>First to find the ğŸ”µ = WINS! (${c.games?.toLocaleString() || 0} games played)</p>
              <p>ğŸ¥‡ Player 1: <strong>${((w[0]||0)/(c.games||1)*100).toFixed(1)}%</strong> | ğŸ¥ˆ Player 2: <strong>${((w[1]||0)/(c.games||1)*100).toFixed(1)}%</strong> | ğŸ¥‰ Player 3: <strong>${((w[2]||0)/(c.games||1)*100).toFixed(1)}%</strong></p>`;
            },
            distExp: () => `<strong>This chart shows which position wins most often.</strong> Player 1 has a huge advantage because they pick first! The further back in the order, the lower the chances.`,
            cumulExp: () => `<strong>Cumulative wins by position.</strong> Early positions accumulate wins quickly. Later players almost never get their chance!`,
            childTitle: "ğŸ§’ Explained to an 8-year-old",
            child: (c) => `<p>Imagine a game where ${c.playersPerGame} kids take turns picking from the same bag.</p><p>The first one to find the blue marble wins!</p><p><strong>It's not very fair:</strong> whoever goes first has much better chances! That's why we draw lots to see who starts ğŸ²</p>`,
            moralTitle: "ğŸ’¡ What this teaches us",
            moral: () => `<p class="quote">ğŸ† Turn order gives a <strong>structural advantage</strong>.<br><strong>Being first often matters more than skill.</strong></p>`
          }
        },
        streak: {
          fr: {
            storyTitle: "ğŸ“– L'Histoire - Streaks",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              const type = c.streakBonus > 0 ? 'augmente' : 'diminue';
              return `<p>ProbabilitÃ© de base: 1/${c.totalBalls}. AprÃ¨s chaque Ã©chec, elle <strong>${type} de ${Math.abs(c.streakBonus)}%</strong>!</p>
              <p>${c.streakBonus > 0 ? 'ğŸ”¥ Main chaude: plus tu perds, plus tu as de chances!' : "â„ï¸ Main froide: plus tu perds, plus c'est dur..."}</p>
              <p>ğŸ€ ${lucky.toLocaleString()} au 1er coup | ğŸ˜… Max: ${s.max.toLocaleString()} tentatives</p>`;
            },
            distExp: (c) => `<strong>${c.streakBonus > 0 ? 'Distribution compressÃ©e - moins de cas extrÃªmes.' : 'Distribution Ã©talÃ©e - plus de cas extrÃªmes!'}</strong> ${c.streakBonus > 0 ? 'La probabilitÃ© croissante rattrape les malchanceux.' : 'La probabilitÃ© dÃ©croissante piÃ¨ge les malchanceux.'}`,
            cumulExp: (c) => `<strong>${c.streakBonus > 0 ? 'Courbe plus pentue = convergence rapide.' : 'Courbe plus plate = convergence lente.'}</strong> ${c.streakBonus > 0 ? 'Tout le monde finit par gagner assez vite.' : 'Certains peuvent rester bloquÃ©s trÃ¨s longtemps!'}`,
            childTitle: "ğŸ§’ ExpliquÃ© Ã  un enfant de 8 ans",
            child: (c) => `<p>${c.streakBonus > 0 ? 'Imagine que plus tu rates, plus le sac devient "gentil" et t\'aide Ã  trouver la bille bleue!' : 'Imagine que plus tu rates, plus le sac devient "mÃ©chant" et cache encore mieux la bille bleue!'}</p><p><strong>Dans la vraie vie, chaque tirage est indÃ©pendant!</strong> Le sac n'a pas de mÃ©moire ğŸ§ </p><p>C'est ce qu'on appelle "l'erreur du joueur" - croire que la chance "doit tourner".</p>`,
            moralTitle: "ğŸ’¡ Ce que Ã§a nous apprend",
            moral: () => `<p class="quote">ğŸ² Dans la vraie vie, chaque tirage est <strong>indÃ©pendant</strong>.<br><strong>Le hasard n'a pas de mÃ©moire!</strong></p>`
          },
          en: {
            storyTitle: "ğŸ“– The Story - Streaks",
            story: (c, s, d) => {
              const lucky = d.get(1) || 0;
              const type = c.streakBonus > 0 ? 'increases' : 'decreases';
              return `<p>Base probability: 1/${c.totalBalls}. After each failure, it <strong>${type} by ${Math.abs(c.streakBonus)}%</strong>!</p>
              <p>${c.streakBonus > 0 ? 'ğŸ”¥ Hot hand: the more you lose, the better your chances!' : 'â„ï¸ Cold hand: the more you lose, the harder it gets...'}</p>
              <p>ğŸ€ ${lucky.toLocaleString()} on 1st try | ğŸ˜… Max: ${s.max.toLocaleString()} attempts</p>`;
            },
            distExp: (c) => `<strong>${c.streakBonus > 0 ? 'Compressed distribution - fewer extreme cases.' : 'Spread out distribution - more extreme cases!'}</strong> ${c.streakBonus > 0 ? 'Increasing probability catches up with the unlucky.' : 'Decreasing probability traps the unlucky.'}`,
            cumulExp: (c) => `<strong>${c.streakBonus > 0 ? 'Steeper curve = fast convergence.' : 'Flatter curve = slow convergence.'}</strong> ${c.streakBonus > 0 ? 'Everyone ends up winning fairly quickly.' : 'Some can stay stuck for a very long time!'}`,
            childTitle: "ğŸ§’ Explained to an 8-year-old",
            child: (c) => `<p>${c.streakBonus > 0 ? 'Imagine that the more you miss, the "nicer" the bag becomes and helps you find the blue marble!' : 'Imagine that the more you miss, the "meaner" the bag becomes and hides the blue marble even better!'}</p><p><strong>In real life, each draw is independent!</strong> The bag has no memory ğŸ§ </p><p>This is called the "gambler's fallacy" - believing that luck "has to turn around".</p>`,
            moralTitle: "ğŸ’¡ What this teaches us",
            moral: () => `<p class="quote">ğŸ² In real life, each draw is <strong>independent</strong>.<br><strong>Randomness has no memory!</strong></p>`
          }
        },
        economy: {
          fr: {
            storyTitle: "ğŸ“– L'Histoire - Ã‰conomie",
            story: (c, s) => {
              const avgCost = s.average * c.cost;
              const profit = c.reward - avgCost;
              const profitable = profit > 0;
              return `<p>Chaque essai coÃ»te <span class="highlight">${c.cost}â‚¬</span>. Gagner rapporte <span class="highlight">${c.reward}â‚¬</span>!</p>
              <p>ğŸ’¸ CoÃ»t moyen: <strong>${avgCost.toFixed(0)}â‚¬</strong> | ğŸ’° Gain net: <strong style="color:${profitable ? '#4ade80' : '#f97316'}">${profit.toFixed(0)}â‚¬</strong></p>
              <p>${profitable ? 'ğŸ“ˆ Jeu RENTABLE sur le long terme!' : 'ğŸ“‰ Jeu PERDANT sur le long terme!'}</p>`;
            },
            distExp: () => `<strong>Chaque barre = un coÃ»t diffÃ©rent pour le joueur.</strong> Les barres de gauche = joueurs chanceux (peu de dÃ©penses). Les barres de droite = joueurs qui ont dÃ©pensÃ© beaucoup!`,
            cumulExp: () => `<strong>% de joueurs ayant "rentabilisÃ©" selon leurs essais.</strong> Plus on est Ã  droite, plus on a dÃ©pensÃ©. La ligne pointillÃ©e serait le seuil de rentabilitÃ©.`,
            childTitle: "ğŸ§’ ExpliquÃ© Ã  un enfant de 8 ans",
            child: (c, s) => {
              const avgCost = s.average * c.cost;
              const profitable = c.reward > avgCost;
              return `<p>Imagine une machine oÃ¹ tu mets ${c.cost}â‚¬ Ã  chaque essai. Si tu gagnes, tu reÃ§ois ${c.reward}â‚¬!</p><p>En moyenne, il faut ${s.average.toFixed(0)} essais pour gagner, donc dÃ©penser ${avgCost.toFixed(0)}â‚¬.</p><p><strong>${profitable ? `Super! Tu gagnes ${(c.reward - avgCost).toFixed(0)}â‚¬ en moyenne! ğŸ‰` : `Attention! Tu perds ${(avgCost - c.reward).toFixed(0)}â‚¬ en moyenne! C'est comme Ã§a que les casinos gagnent de l'argent ğŸ’¸`}</strong></p>`;
            },
            moralTitle: "ğŸ’¡ Ce que Ã§a nous apprend",
            moral: (c, s) => {
              const avgCost = s.average * c.cost;
              const profitable = c.reward > avgCost;
              return `<p class="quote">${profitable ? 'âœ… Ce jeu est mathÃ©matiquement rentable.' : 'âŒ Ce jeu est mathÃ©matiquement perdant.'}<br><strong>L'espÃ©rance = ce que tu gagnes en moyenne sur le long terme.</strong></p>`;
            }
          },
          en: {
            storyTitle: "ğŸ“– The Story - Economy",
            story: (c, s) => {
              const avgCost = s.average * c.cost;
              const profit = c.reward - avgCost;
              const profitable = profit > 0;
              return `<p>Each try costs <span class="highlight">${c.cost}â‚¬</span>. Winning earns <span class="highlight">${c.reward}â‚¬</span>!</p>
              <p>ğŸ’¸ Average cost: <strong>${avgCost.toFixed(0)}â‚¬</strong> | ğŸ’° Net profit: <strong style="color:${profitable ? '#4ade80' : '#f97316'}">${profit.toFixed(0)}â‚¬</strong></p>
              <p>${profitable ? 'ğŸ“ˆ Game is PROFITABLE in the long run!' : 'ğŸ“‰ Game is a LOSS in the long run!'}</p>`;
            },
            distExp: () => `<strong>Each bar = a different cost for the player.</strong> Left bars = lucky players (low spending). Right bars = players who spent a lot!`,
            cumulExp: () => `<strong>% of players who "broke even" based on attempts.</strong> Further right = more spent. The dotted line would be the break-even point.`,
            childTitle: "ğŸ§’ Explained to an 8-year-old",
            child: (c, s) => {
              const avgCost = s.average * c.cost;
              const profitable = c.reward > avgCost;
              return `<p>Imagine a machine where you put ${c.cost}â‚¬ for each try. If you win, you get ${c.reward}â‚¬!</p><p>On average, it takes ${s.average.toFixed(0)} tries to win, so you spend ${avgCost.toFixed(0)}â‚¬.</p><p><strong>${profitable ? `Great! You win ${(c.reward - avgCost).toFixed(0)}â‚¬ on average! ğŸ‰` : `Watch out! You lose ${(avgCost - c.reward).toFixed(0)}â‚¬ on average! That's how casinos make money ğŸ’¸`}</strong></p>`;
            },
            moralTitle: "ğŸ’¡ What this teaches us",
            moral: (c, s) => {
              const avgCost = s.average * c.cost;
              const profitable = c.reward > avgCost;
              return `<p class="quote">${profitable ? 'âœ… This game is mathematically profitable.' : 'âŒ This game is mathematically a loss.'}<br><strong>Expected value = what you win on average in the long run.</strong></p>`;
            }
          }
        },
        multi: {
          fr: {
            storyTitle: "ğŸ“– L'Histoire - Multi-cibles",
            story: (c, s) => `<p>Il faut trouver <span class="highlight">${c.targetBalls} boules bleues</span>! (avec remise)</p>
              <p>Moyenne thÃ©orique: ~${(c.totalBalls * c.targetBalls).toLocaleString()} tentatives</p>
              <p>ğŸ€ Min: <strong>${s.min}</strong> | ğŸ“Š Moyenne: <strong>${s.average.toFixed(0)}</strong> | ğŸ˜… Max: <strong>${s.max.toLocaleString()}</strong></p>`,
            distExp: (c) => `<strong>Distribution dÃ©calÃ©e vers la droite.</strong> Plus on cherche de boules, plus le "pic" se dÃ©place. C'est la somme de ${c.targetBalls} distributions gÃ©omÃ©triques!`,
            cumulExp: (c, s, p50) => `<strong>Courbe plus "S" que pour une seule boule.</strong> Le dÃ©but est plus plat (impossible de finir trÃ¨s vite). 50% rÃ©ussissent en ~${p50} tentatives.`,
            childTitle: "ğŸ§’ ExpliquÃ© Ã  un enfant de 8 ans",
            child: (c, s) => `<p>Au lieu de chercher 1 bille bleue, tu dois en trouver ${c.targetBalls}!</p><p>C'est ${c.targetBalls}x plus long en moyenne. Mais parfois BEAUCOUP plus pour les malchanceux (${s.max.toLocaleString()} essais!).</p><p><strong>Plus l'objectif est grand, plus les Ã©carts entre chanceux et malchanceux sont Ã©normes!</strong></p>`,
            moralTitle: "ğŸ’¡ Ce que Ã§a nous apprend",
            moral: () => `<p class="quote">ğŸ“ˆ Objectifs multiples = temps Ã— N mais variance Ã— NÂ²<br><strong>Les grands objectifs amplifient les inÃ©galitÃ©s.</strong></p>`
          },
          en: {
            storyTitle: "ğŸ“– The Story - Multi-target",
            story: (c, s) => `<p>You need to find <span class="highlight">${c.targetBalls} blue balls</span>! (with replacement)</p>
              <p>Theoretical average: ~${(c.totalBalls * c.targetBalls).toLocaleString()} attempts</p>
              <p>ğŸ€ Min: <strong>${s.min}</strong> | ğŸ“Š Average: <strong>${s.average.toFixed(0)}</strong> | ğŸ˜… Max: <strong>${s.max.toLocaleString()}</strong></p>`,
            distExp: (c) => `<strong>Distribution shifted to the right.</strong> The more balls you're looking for, the more the "peak" shifts. It's the sum of ${c.targetBalls} geometric distributions!`,
            cumulExp: (c, s, p50) => `<strong>More "S-shaped" curve than for a single ball.</strong> The beginning is flatter (impossible to finish very quickly). 50% succeed in ~${p50} attempts.`,
            childTitle: "ğŸ§’ Explained to an 8-year-old",
            child: (c, s) => `<p>Instead of looking for 1 blue marble, you need to find ${c.targetBalls}!</p><p>It takes ${c.targetBalls}x longer on average. But sometimes MUCH more for the unlucky ones (${s.max.toLocaleString()} tries!).</p><p><strong>The bigger the goal, the larger the gap between lucky and unlucky people!</strong></p>`,
            moralTitle: "ğŸ’¡ What this teaches us",
            moral: () => `<p class="quote">ğŸ“ˆ Multiple goals = time Ã— N but variance Ã— NÂ²<br><strong>Big goals amplify inequalities.</strong></p>`
          }
        }
      };
      return content[mode]?.[currentLang] || content[mode]?.fr;
    }

    const modeContent = {
      get(mode) {
        const c = getModeContent(mode);
        return {
          getStory: (config, stats, dist) => `<h2>${c.storyTitle}</h2>${c.story(config, stats, dist)}`,
          getDistExplanation: (config, stats) => c.distExp(config, stats),
          getCumulExplanation: (config, stats, p50, p90) => c.cumulExp(config, stats, p50, p90),
          getChildExplanation: (config, stats) => `<h2>${c.childTitle}</h2>${c.child(config, stats)}`,
          getMoral: (config, stats) => `<h2>${c.moralTitle}</h2>${c.moral(config, stats)}`
        };
      }
    };

    // Simulation functions
    function simulateReplacement(config) {
      const results = [];
      for (let i = 0; i < config.players; i++) {
        let attempts = 0;
        while (true) {
          attempts++;
          if (Math.floor(Math.random() * config.totalBalls) < config.blueBalls) break;
        }
        results.push(attempts);
      }
      return results;
    }

    function simulateNoReplacement(config) {
      const results = [];
      for (let i = 0; i < config.players; i++) {
        let remaining = config.totalBalls;
        let blueLeft = config.blueBalls;
        let attempts = 0;
        while (blueLeft > 0) {
          attempts++;
          if (Math.floor(Math.random() * remaining) < blueLeft) break;
          remaining--;
        }
        results.push(attempts);
      }
      return results;
    }

    function simulatePity(config) {
      const results = [];
      const baseProb = config.blueBalls / config.totalBalls;
      for (let i = 0; i < config.players; i++) {
        let attempts = 0;
        while (true) {
          attempts++;
          let prob = baseProb;
          if (attempts > config.pityStart) {
            const progress = (attempts - config.pityStart) / (config.pityGuarantee - config.pityStart);
            prob = baseProb + (1 - baseProb) * Math.min(1, progress);
          }
          if (Math.random() < prob) break;
        }
        results.push(attempts);
      }
      return results;
    }

    function simulateCompetition(config) {
      const games = Math.floor(config.players / config.playersPerGame);
      const winsByPosition = new Array(config.playersPerGame).fill(0);
      const results = [];

      for (let g = 0; g < games; g++) {
        let remaining = config.totalBalls;
        let blueLeft = config.blueBalls;
        let turn = 0;

        while (blueLeft > 0 && remaining > 0) {
          const playerIndex = turn % config.playersPerGame;
          if (Math.floor(Math.random() * remaining) < blueLeft) {
            winsByPosition[playerIndex]++;
            results.push(playerIndex + 1);
            break;
          }
          remaining--;
          turn++;
        }
      }

      config.games = games;
      config.winsByPosition = winsByPosition;
      return results;
    }

    function simulateStreak(config) {
      const results = [];
      const baseProb = config.blueBalls / config.totalBalls;
      for (let i = 0; i < config.players; i++) {
        let attempts = 0;
        let streak = 0;
        while (true) {
          attempts++;
          const modifier = 1 + (streak * config.streakBonus / 100);
          const prob = Math.min(1, Math.max(0.001, baseProb * modifier));
          if (Math.random() < prob) break;
          streak++;
        }
        results.push(attempts);
      }
      return results;
    }

    function simulateEconomy(config) {
      return simulateReplacement(config);
    }

    function simulateMulti(config) {
      const results = [];
      for (let i = 0; i < config.players; i++) {
        let attempts = 0;
        let found = 0;
        while (found < config.targetBalls) {
          attempts++;
          if (Math.floor(Math.random() * config.totalBalls) < config.blueBalls) {
            found++;
          }
        }
        results.push(attempts);
      }
      return results;
    }

    // Calculate stats
    function calculateStats(results) {
      const sorted = [...results].sort((a, b) => a - b);
      const sum = results.reduce((a, b) => a + b, 0);
      const count = results.length;
      return {
        count,
        min: sorted[0],
        max: sorted[count - 1],
        average: sum / count,
        median: count % 2 === 0
          ? (sorted[count/2 - 1] + sorted[count/2]) / 2
          : sorted[Math.floor(count/2)]
      };
    }

    function buildDistribution(results) {
      const dist = new Map();
      for (const r of results) {
        dist.set(r, (dist.get(r) || 0) + 1);
      }
      return new Map([...dist].sort((a, b) => a[0] - b[0]));
    }

    // UI functions
    function selectMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });

      document.querySelectorAll('[id$="-config"]').forEach(el => el.style.display = 'none');
      (modeConfigs[mode]?.showConfigs || []).forEach(id => {
        document.getElementById(id).style.display = 'block';
      });
    }

    function getConfig() {
      const redBalls = parseInt(document.getElementById('redBalls').value);
      const blueBalls = parseInt(document.getElementById('blueBalls').value);
      return {
        players: parseInt(document.getElementById('players').value),
        redBalls,
        blueBalls,
        totalBalls: redBalls + blueBalls,
        pityStart: parseInt(document.getElementById('pityStart').value),
        pityGuarantee: parseInt(document.getElementById('pityGuarantee').value),
        playersPerGame: parseInt(document.getElementById('playersPerGame').value),
        streakBonus: parseInt(document.getElementById('streakBonus').value),
        cost: parseInt(document.getElementById('cost').value),
        reward: parseInt(document.getElementById('reward').value),
        targetBalls: parseInt(document.getElementById('targetBalls').value)
      };
    }

    function updateCharts(distribution, stats) {
      const labels = [...distribution.keys()].slice(0, 80);
      const values = [...distribution.values()].slice(0, 80);

      let cumulative = 0;
      const cumulativeData = values.map(v => {
        cumulative += v;
        return (cumulative / stats.count * 100).toFixed(2);
      });

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#888', maxTicksLimit: 10 }, grid: { color: 'rgba(255,255,255,0.1)' } },
          y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        }
      };

      if (distributionChart) distributionChart.destroy();
      distributionChart = new Chart(document.getElementById('distributionChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: 'rgba(233, 69, 96, 0.7)',
            borderColor: 'rgba(233, 69, 96, 1)',
            borderWidth: 1
          }]
        },
        options: chartOptions
      });

      if (cumulativeChart) cumulativeChart.destroy();
      cumulativeChart = new Chart(document.getElementById('cumulativeChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: cumulativeData,
            borderColor: 'rgba(74, 222, 128, 1)',
            backgroundColor: 'rgba(74, 222, 128, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 100 } } }
      });
    }

    function updateStats(stats, distribution, config) {
      let cumulative = 0;
      let p50 = 0, p90 = 0;
      for (const [attempts, count] of distribution) {
        cumulative += count;
        if (!p50 && cumulative >= stats.count * 0.5) p50 = attempts;
        if (!p90 && cumulative >= stats.count * 0.9) p90 = attempts;
      }

      const luckyCount = distribution.get(1) || distribution.get(stats.min) || 0;
      const s = t('ui.stats');

      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card lucky"><div class="value">ğŸ€ ${luckyCount.toLocaleString()}</div><div class="label">${s.lucky}</div></div>
        <div class="stat-card unlucky"><div class="value">ğŸ˜… ${stats.max.toLocaleString()}</div><div class="label">${s.max}</div></div>
        <div class="stat-card"><div class="value">${stats.average.toFixed(0)}</div><div class="label">${s.average}</div></div>
        <div class="stat-card"><div class="value">${stats.median}</div><div class="label">${s.median}</div></div>
        <div class="stat-card"><div class="value">${p50}</div><div class="label">${s.p50}</div></div>
        <div class="stat-card"><div class="value">${p90}</div><div class="label">${s.p90}</div></div>
      `;

      return { p50, p90 };
    }

    async function runSimulation() {
      const btn = document.getElementById('runBtn');
      const progressBar = document.getElementById('progressBar');

      btn.disabled = true;
      btn.textContent = t('ui.runningBtn');
      progressBar.classList.add('visible');
      progressBar.querySelector('.fill').style.width = '30%';

      await new Promise(r => setTimeout(r, 50));

      const config = getConfig();
      let results;

      switch (currentMode) {
        case 'replacement': results = simulateReplacement(config); break;
        case 'no-replacement': results = simulateNoReplacement(config); break;
        case 'pity': results = simulatePity(config); break;
        case 'competition': results = simulateCompetition(config); break;
        case 'streak': results = simulateStreak(config); break;
        case 'economy': results = simulateEconomy(config); break;
        case 'multi': results = simulateMulti(config); break;
      }

      progressBar.querySelector('.fill').style.width = '70%';
      await new Promise(r => setTimeout(r, 50));

      const stats = calculateStats(results);
      const distribution = buildDistribution(results);
      const { p50, p90 } = updateStats(stats, distribution, config);

      progressBar.querySelector('.fill').style.width = '100%';

      const content = modeContent.get(currentMode);
      document.getElementById('storyBox').innerHTML = content.getStory(config, stats, distribution);
      document.getElementById('distExplanation').innerHTML = content.getDistExplanation(config, stats);
      document.getElementById('cumulExplanation').innerHTML = content.getCumulExplanation(config, stats, p50, p90);
      document.getElementById('childBox').innerHTML = content.getChildExplanation(config, stats);
      document.getElementById('moralBox').innerHTML = content.getMoral(config, stats);

      updateCharts(distribution, stats);

      document.getElementById('placeholder').style.display = 'none';
      document.getElementById('results').classList.add('visible');

      btn.disabled = false;
      btn.textContent = t('ui.runBtn');
      setTimeout(() => progressBar.classList.remove('visible'), 500);
    }

    // Event listeners
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => selectMode(btn.dataset.mode));
    });

    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentLang = btn.dataset.lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === currentLang));
        document.documentElement.lang = currentLang;
        updateStaticUI();
      });
    });

    document.getElementById('runBtn').addEventListener('click', runSimulation);

    // Initialize
    selectMode('replacement');
    updateStaticUI();
  </script>
</body>
</html>
